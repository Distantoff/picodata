get_all_targets(SOURCE_TARGETS ${PROJECT_SOURCE_DIR}/src)

list(APPEND LUA_CPATH "${PROJECT_BINARY_DIR}/src/server/?.so")
list(APPEND LUA_CPATH "${PROJECT_BINARY_DIR}/src/server/?.dylib")
list(JOIN LUA_CPATH "\;" LUA_CPATH)

add_custom_target(test
    DEPENDS ${SOURCE_TARGETS}
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    COMMAND ${CMAKE_COMMAND} -E env
    "PICODATA_EXECUTABLE=${PICODATA_EXECUTABLE}"
    "LUA_CPATH=${LUA_CPATH}"
    pytest)
