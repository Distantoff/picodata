# Работа с данными через Lua API
В данном разделе приведены примеры команд для работы с данными в
Picodata с помощью [Lua API](api.md). Этот способ относится к работе с
глобальными реплицированными [спейсами](glossary.md#space).
СУБД.

## Создание глобального спейса {: #creating-global-space }

После подключения к инстансу кластера посредством команды `picodata
connect`, в интерактивной консоли Picodata доступна функция
`pico.create_space()`, позволяющая создавать глобальные спейсы.

Для примера создадим шаблон списка друзей Свинки Пеппы, в
котором будет два поля: идентификатор записи и имя друга:

```lua
pico.create_space({
    name = 'friends_of_peppa',
    format = {
        {name = 'id', type = 'unsigned', is_nullable = false},
        {name = 'name', type = 'string', is_nullable = false},
    },
    primary_key = {'id'},
    distribution = 'global',
    timeout = 3,
})
```

Ключ _distribution_ отвечает за тип спейса. В примере указан глобальный
тип (_global_).

_Примечание_. На данном этапе можно создать также и шардированный
спейс (следует указать тип _sharded_ и добавить параметр
`sharding_key`), однако с ним можно будет работать только через функцию
`pico.sql`. См. [подробнее](tutorial_sql).

Значение “3.0” означает таймаут в секундах перед
возвращением управления пользователю (т.к. действие производится на всем
кластере, оно может занять продолжительное время). Для ключа `type`
допустимы те же типы полей, что и в `space_object:format()` в Tarantool
([подробнее](https://www.tarantool.io/ru/doc/latest/reference/reference_lua/box_space/format/)).

Спейс является необходимым элементом схемы данных, распространяемой на
все узлы кластера. Каждое действие по созданию/удалению спейсов в
Picodata увеличивает номер схемы данных. В пустом кластере изначально
схема данных имеет индекс 0, после чего он инкрементируется при каждом
изменении содержимого кластера. Любое действие по
созданию/изменению/удалению спейсов, работе с индексами хранения и т.д.
является изменением схемы данных.


## Запись данных в глобальный спейс {: #writing-to-global-space }
Запись данных, т.е. вставка строк, в спейс происходит с помощью следующей команды:
```lua
      suzy_insert_index = pico.cas({
          kind = 'insert',
          space = 'friends_of_peppa',
          tuple = {1, 'Suzy'},
      })
```

Команда вернет индекс записи raft-журнала, содержащей этот запрос. Этот
индекс будет присвоен переменной `suzy_insert_index`, которая
понадобится для [следующего примера](#insert-with-index).

Такая запись подразумевает, что у нас имеется таблица с двумя столбцами
подходящего формата (`unsigned` и `string`), и что
[терм](glossary.md#term) на текущем инстансе не устарел.

Более подробный вариант записи предполагает явное использование проверки
предиката с помощью алгоритма [Compare and swap](glossary.md#cas).

Проверка предиката состоит в контроле за следующими параметрами:

- `index`, индекс записи raft-журнала, начиная с которого будет
  происходить проверка параметра `ranges`. По умолчанию берется текущий
  индекс.
- `term`, номер терма, соответствующий параметру `index`. По умолчанию
  берется текущий терм.
- `ranges`, диапазоны внутри спейсов, используемые для проверки [Compare
  and swap](glossary.md#cas). Проверка проходит если записи,
  соответствующие диапазонам из массива `ranges`, остались не
  измененными на отрезке времени от указанного индекса и до применения
  данного запроса `pico.cas()`. Если это не так, запрос `pico.cas()`
  вернет ошибку.

Для примера добавим в таблицу строку с еще одним другом Пеппы, но с
условием, что до этого ни одна другая запись не была добавлена после
Suzy: <a name="insert-with-index"></a>

```lua
      pico.cas({
          kind = 'replace',
          space = 'friends_of_peppa',
          tuple = {2, 'Rebecca'},
      }, {
          index = suzy_insert_index
          ranges = {{
              space = 'friends_of_peppa',
              key_min = { kind = 'excluded', key = {1,} },
              key_max = { kind = 'unbounded' },
          }},
      })

```
Проверка предиката имеет смысл в распределенной системе, где запросы на
изменение данных в БД с разных инстансов не знают друг о друге. См.
[подробнее](api.md#casrange) об использовании диапазонов в предикате.


## Чтение данных из глобального спейса {: #reading-from-global-space }
Для чтения данных из глобального спейса подойдёт команда:
```
box.space.friends_of_peppa:select()
```

Можно вывести отдельно названия столбцов в спейсе:
```
box.space.friends_of_peppa:format()
```

## Удаление данных {: #deleting-from-global-space }

Простой вариант удаления строки с известным `id`:

```lua
pico.cas({
          kind = 'delete',
          space = 'friends_of_peppa',
          key = {2},
      })
```

Удаление с явным указанием индекса, терма и предиката:

```lua
index, term =
   assert(pico.raft_get_index()),
   assert(pico.raft_status()).term

delete_rebecca = {
    kind = 'delete',
    space = 'friends_of_peppa',
    key = {2}
}

predicate = {
    index = index,
    term = term,
    ranges = {{
        space = 'friends_of_peppa',
        key_min = { kind = 'included', key = {2} },
        key_max = { kind = 'included', key = {2} },
    }},
}

pico.cas(delete_rebecca, predicate)
```

Явное указание индекса и терма имеет смысл, если автоматически
подставленные текущие индекс и терм не подойдут. Например в случае,
когда между формированием cas-запроса и его отправкой прошло какое-то
время и в кластере были зафиксированы другие изменения.

Приведенный выше пример поможет сделать первые шаги в работе с данными в
Picodata. Подробнее о внутренней архитектуре кластера Picodata см. в
разделе [Cхема инициализации кластера](../clustering).

Параметры запуска из командной строки описаны в разделе [Аргументы
командной строки Picodata](../cli).

---
[Исходный код страницы](https://git.picodata.io/picodata/picodata/docs/-/blob/main/docs/tutorial_lua.md)

