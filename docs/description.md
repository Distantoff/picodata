# Общее описание продукта
## Что такое Picodata?
Программное обеспечение Picodata — это сервер приложений со встроенной базой данных для работы в распределённых системах.
Picodata предоставляет систему хранения данных и платформу для работы персистентных приложений на языке Rust и средства управления СУБД на языке SQL.

## Назначение
Основным предназначением продукта Picodata является горизонтально масштабируемое хранение структурированных и неструктурированных данных, управление ими, предоставление среды вычислений внутри кластера, состоящего из реплицированных отдельных узлов. Такие узлы называют экземплярами Picodata или *инстансами*.

## Задачи
Задачи, решаемые ПО Picodata, включают в себя:

* Реализацию общего линеаризованного хранилища конфигурации, схемы данных и топологии кластера, встроенного в распределенную систему управления базами данных.
* Предоставление графического интерфейса и интерфейса командной строки по управлению топологией кластера.
* Реализацию runtime-библиотек по работе с сетью, файловому вводу-выводу, созданию зеленых потоков (green threads) и управлению ими, работе со встроенной СУБД средствами языка Rust.
* Поддержку языка SQL для работы как с данными отдельного инстанса, так и с данными всего кластера.
* Управление кластером.
* Поддержку жизненного цикла приложения в кластере, включая версионирование, управление зависимостями, упаковку дистрибутива, развертывание и обновление запущенных приложений.

## Область применения
Хранилище данных с использованием ПО Picodata обладает явными преимуществами, которые во многом определяют наиболее выгодные области применения. Речь идёт о быстром доступе к данным внутри распределённого хранилища. Примерами могут служить:

* управление телекоммуникационным оборудованием;
* банковские и в целом финансовые услуги, биржевые торги, аукционы;
* формирование персональных маркетинговых предложений с привязкой ко времени и месту;
* обработка больших объёмов данных в реальном времени для систем класса "интернет вещей" (IoT);
* игровые рейтинговые таблицы;
* и многое другое!

## Преимущества
Picodata позволяет развёртывать и управлять кластерами с СУБД Tarantool, используя следующие возможности:

* горизонтальное масштабирование кластера с использованием библиотеки логического шардирования и собственных высокоуровневых инструментов, облегчающих работу администраторов и разработчиков.
* гибкое управление вычислительной нагрузкой за счёт реплицирования инстансов кластера и автоматизированной балансировки.
* гибкое удаление устаревших данных.
* гибкое обновление схемы данных и изменение топологии кластера,в например добавление новых инстансов к уже работающему кластеру.
* обеспечение высокой доступности и персистентности данных сразу, без использования дополнительного инструментария.

## Архитектура
### Составные части кластера
Архитектура кластера под управлением Picodata предполагает систему отдельных *инстансов* — программных узлов, входящих в состав кластера. Каждый такой узел может выполнять различные роли, например роль хранения данных, роль сервера приложения, или служебную роль координатора кластера.
Все инстансы работают с единой схемой данных и кодом приложения. Каждый процесс базы данных выполняется на одном процессорном ядре и хранит все свои данные в оперативной памяти. 
Любой отдельный инстанс является часть набора реплик, который также называют *репликасетом*. Репликасет может состоять из одного или нескольких инстансов — дубликатов одного и того же набора данных. Внутри репликасета всегда есть *активный* инстанс и — если реплик больше 1 — то некоторое число дополнительных инстансов, обеспечивающих отказоустойчивость системы в случае выхода из строя или недоступности активного инстанса. Число реплик определяется *фактором репликации*, заданным для набора в глобальных настройках Picodata.

На рисунке ниже показана схема простого кластера из двух репликасетов, каждый из которых состоит из двух инстансов (активного и в ожидании):

![Схема кластера](cluster.svg)

Репликасеты являются единицами физического масштабирования кластера. Данные балансируются между ними автоматически.

### Хранение данных
Внутри каждого репликасета есть *bucket* — виртуализированная неделимая единица хранения, обеспечивающая локальность данных (например, хранение нескольких связанных с клиентом записей на одном физическом узле сети). Принадлежность данных определённому bucket'у обеспечивается добавлением идентификатора (bucket id) ко всем строкам таблицы в БД. Сам по себе bucket не имеет ограничений по ёмкости и может содержать любой объём данных. Горизонтальное масштабирование позволяет распределить bucket'ы по разным устройствам хранения, оптимизировав производительность кластера путём добавления новых реплицированных инстансов. Чем больше репликасетов входит в состав кластера, тем меньше bucket'ов хранится на каждом из них. Это увеличивает скорость выполнения запросов к БД и одновременно с этим снижает нагрузку на сетевую инфраструктуру кластера. Bucket всегда хранится физически на одном репликасете и является промежуточным звеном между данными и устройством хранения. В каждом репликасете может быть много bucket'ов (или не быть не одного). Внутри bucket'а данные задублированы по всем инстансам в рамках репликасета в соответствие с фактором репликации. Количество bucket'ов задаётся при первоначальной настройке кластера.

На схеме ниже показан пример схемы хранения данных внутри репликасета:

![Хранение данных](storage.svg)

### Отказоустойчивость
Наличие нескольких реплик внутри репликасета обеспечивают его отказоустойчивость. Дополнительно, для повышения надёжности каждый инстанс кластера внутри репликасета находится на разных физических серверах, а также, как правило, в разных, географически удалённых друг от друга датацентрах. Таким образом, репликасет в случае недоступности или выхода из строя датацентра продолжает работать, делая активным другой инстанс. 

Пример географического распределения репликасета показан на схеме ниже:

![Отказоустойчивость](failover.svg)

### Шардирование
Шардирование — это распределение bucket'ов между различными репликасетами. Данная функция обеспечивается Picodata для более эффективного хранения данных в распределённом кластере. С этой точки зрения, каждый репликасет является *шардом*, и чем больше репликасетов имеется в кластере, тем эффективнее данная функция может разделить массив данных на отдельные наборы данных меньшего размера. При добавлении новых инстансов в кластер и/или формировании новых репликасетов, Picodata автоматически распределит bucket'ы с учётом новой конфигурации. Если у всех инстансов указан одинаковый *вес* (weight), то bucket'ы будут распределены равномерно (если у какого-либо инстанса вес выше, то он сможет принять больше bucket'ов).
Пример автоматического шардирования при добавлении в кластер новых инстансов показан на схеме ниже:

![Шардирование](sharding.svg)

Таким образом, каждый инстанс (экземпляр Picodata) является *частью репликасета*, а каждый репликасет — является *шардом*, а шарды распределены между несколькими серверами.

## Настройка и запуск кластера
Picodata позволяет запустить отдельные экземпляры Tarantool (инстансы) и тут же собрать их в один кластер. Каждый инстанс при запуске содержит ряд обязательных параметров, включая:

* идентификатор кластера (должен совпадать у всех инстансов);
* уникальный идентификатор самого инстанса;
* фактор репликации (число инстансов в репликасете);
* сетевой адрес и порт текущего инстанса (*peer*) и желательно какого-либо другого инстанса;
* домен отказа (принадлежность инстанса физическому серверу).

Для того чтобы все инстансы сформировали один кластер, нужно для каждого из них указать набор peer'ов хотя бы из двух позиций: текущего инстанса и какого-либо другого (или несколько других). Picodata сможет собрать кластер при выполнении следующего условия: **у любой пары инстансов должен быть хотя бы один общий *peer***. 

Использование параметра *домен отказа* (failure domain) необходимо для того, чтобы в репликасет попали инстансы, запущенные на разных серверах или датацентрах. Это обеспечит необходимую отказоустойчивость.
Для сборки и поддержания работы кластера Picodata использует алгоритм Raft, который хранит глобальную конфигурацию всех инстансов в специальном журнале Raft Log. Из него эти данные автоматически попадают в локальные конфигурации отдельных экземпляров Tarantool. В частности, эти данные включают в себя информацию о репликасетах и адреса находящихся в них инстансах, что необходимо для шардирования (распределения bucket'ов по репликасетам).

Picodata позволяет работать с глобальной конфигурацией кластера и администрировать его без трудоёмкой и ненадёжной перенастройки отдельных инстансов. 