# Неблокирующие запросы

При работе с распределенными SQL-запросами следует принимать в расчет
следующие факторы:

- SQL-запрос может вызывать значительные задержки и блокировать
  транзакционный поток, что будет мешать выполнению других запросов;
- SQL-запрос не должен приводить к исчерпанию памяти на отдельных узлах
  кластера
- при объединении результатов локальных запросов в виртуальную таблицу
  на узле-маршрутизаторе нужно следить, чтобы эта таблица не
  разрасталась бесконтрольно

Для решения этих задач в DQL- и DML-запросах предусмотрены следующие
необязательные параметры:

- `SQL_VDBE_MAX_STEPS`, ограничение на максимальное количество
  [опкодов ](../../overview/glossary.md#opcode) при исполнении
  локального плана виртуальным движком базы данных
  ([VDBE](https://www.sqlite.org/vdbe.html)) на экземпляре кластера.
- `VTABLE_MAX_ROWS`, ограничение на максимальное число строк в
  результирующей виртуальной таблице, собирающей результаты отдельных
  локальных запросов.

Параметр `SQL_VDBE_MAX_STEPS` представляет собой лимит счетчика команд
при исполнении скомпилированного запроса в VDBE-машине. Ограничение
`SQL_VDBE_MAX_STEPS` позволяет предотвратить выполнение запроса в тех
случаях, если запрашиваемая таблица слишком велика и сигнализировать
пользователю о необходимости переделать запрос (например отказаться от
полного сканирования (`SELECT * ...`) такой таблицы).

Точное число требуемых опкодов в условиях распределенного кластера
посчитать невозможно. Чем больше операций, сравнений, соединений и
других действий нужно проделать запросу — тем больше будут это значение.

Cм. также:

  - [The SQLite Bytecode Engine](https://www.sqlite.org/opcode.html)

<!--
Локально, получение минимальной таблицы 1х1 требует 8 опкодов. Каждая
дополнительная колонка прибавляет 1 опкод, строка — N+2, где N — число
колонок в таблице. Один фильтр `WHERE` добавляет еще 2 опкода (для
сравнения двух значений).
 -->

## Примеры {: #examples }

??? example "Тестовые таблицы"
    Примеры использования команд включают в себя запросы к [тестовым
    таблицам](../legend.md).

Пример совместного использования `SQL_VDBE_MAX_STEPS` и `VTABLE_MAX_ROWS`:


```sql
SELECT * FROM warehouse OPTION(SQL_VDBE_MAX_STEPS = 30, VTABLE_MAX_ROWS = 5);
+----+----------+---------+
| ID | ITEM     | TYPE    |
+=========================+
| 1  | "bricks" | "heavy" |
|----+----------+---------|
| 2  | "bars"   | "light" |
|----+----------+---------|
| 3  | "blocks" | "heavy" |
|----+----------+---------|
| 4  | "piles"  | "light" |
|----+----------+---------|
| 5  | "panels" | "light" |
+----+----------+---------+
(5 rows)
```

Если ограничения не позволяют выполнить запрос, то будет возвращена
ошибка.

При меньших значениях `SQL_VDBE_MAX_STEPS`:

```
---
- null
- ("Reached a limit on max executed vdbe opcodes. Limit: XX\")
...
```

При слишком низком значении `VTABLE_MAX_ROWS`:

```
---
- null
- (Exceeded maximum number of rows (4) in virtual table: Х\")
...
```
