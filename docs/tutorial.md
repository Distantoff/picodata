# Пример работы с кластером Picodata
В данном разделе приведены примеры команд для работы с данными в Picodata.


## Создание спейса
Перед тем как начать пользоваться СУБД, необходимо создать спейс, т.е.
пространство хранения данных. В терминологии Tarantool спейс аналогичен
таблицам в других реляционных СУБД. 

После подключения к инстансу кластера посредством команды `picodata
connect`, начальным действием в пустом кластере будет создание первого
спейса. Пусть это будет шаблон списка друзей Свинки Пеппы, в
котором будет два поля: идентификатор записи и имя друга:

```lua
pico.create_space({
    name = 'friends_of_peppa',
    format = {
        {name = 'id', type = 'unsigned', is_nullable = false},
        {name = 'name', type = 'string', is_nullable = false},
    },
    primary_key = {'id'},
    distribution = 'global',
    timeout = 3,
})
```

Ключ _distribution_ отвечает за тип спейса. В примере указан глобальный
тип (_global_); также поддерживаются шардированные спейсы (следует
указать тип _sharded_). Значение “3.0” означает таймаут в секундах перед
возвращением управления пользователю (т.к. действие производится на всем
кластере, оно может занять продолжительное время). Для ключа `type`
допустимы те же типы полей, что и в `space_object:format()` в Tarantool
([подробнее](https://www.tarantool.io/ru/doc/latest/reference/reference_lua/box_space/format/)).  

Спейс является необходимым элементом схемы данных, распространяемой на
все узлы кластера. Каждое действие по созданию/удалению спейсов в
Picodata увеличивает номер схемы данных. В пустом кластере изначально
схема данных имеет индекс 0, после чего он инкрементируется при каждом
изменении содержимого кластера. Любое действие по
созданию/изменению/удалению спейсов, работе с индексами хранения и т.д.
является изменением схемы данных. 


## Запись данных в спейс
Простой вариант записи данных в спейс:

```lua
      pico.cas({
          kind = 'insert',
          space = 'friends_of_peppa',
          tuple = {1, 'Suzy'},
      })
```
Такая запись подразумевает, что у нас имеется таблица с двумя столбцами
подходящего формата (`unsigned` и `string`), и что
[терм](glossary.md#term) на текущем инстансе не устарел.

Более подробный вариант записи предполагает явное использование проверки
предиката с помощью алгоритма [Compare and swap](glossary.md#cas).

Проверка предиката состоит в контроле за следующими параметрами:

- `index`, индекс записи raft-журнала, начиная с которой, будет
  происходить проверка параметра`ranges`. По умолчанию берется текущий
  индекс.
- `term`, номер терма, соответствующий параметру `index`. По умолчанию
  берется текущий терм.
- `ranges`, проверка равенства значений, а также проверка диапазона
  значений ключа `primary_key` внутри спейсов. Проверка проходит, если
  записи, соответствующие значениям из массива `ranges`, остались не
  измененными на отрезке времени от указанного индекса и до применения
  данного запроса `pico.cas()`. Если это не так, запрос `pico.cas()`
  вернет ошибку.

Для примера добавим в таблицу строку с ещё одним другом Пеппы, но с
условием, что до этого ни одна другая запись не была добавлена после Suzy:

```lua
      pico.cas({
          kind = 'replace',
          space = 'friends_of_peppa',
          tuple = {2, 'Rebecca'},
      }, {
          ranges = {{
              space = 'friends_of_peppa',
              key_min = { kind = 'excluded', key = {1,} },
              key_max = { kind = 'unbounded' },
          }},
      })

```
Проверка предиката имеет смысл в распределенной системе, где запросы на
изменение данных в БД с разных инстансов не знают друг о друге. См.
[подробнее](api.md#casrange) об использовании диапазонов в предикате.


## Чтение данных
Для чтения данных из спейса подойдёт команда:
```
box.space.friends_of_peppa:select()
```

Отдельно можно узнать, какие именно поля (названия столбцов) есть спейсе:
```
box.space.friends_of_peppa:format()
```

## Удаление данных

Простой вариант удаления строки с известным `id`:

```lua
pico.cas({
          kind = 'delete',
          space = 'friends_of_peppa',
          key = {2},
      })
```

Удаление с явным указанием индекса, терма и предиката (для избежания
конфликтов с другими операциями).

```lua
index, term =
   assert(pico.raft_get_index()),
   assert(pico.raft_status()).term

pico.cas({
          kind = 'delete',
          space = 'friends_of_peppa',
          key = {2},
      }, {
          index = index,
          term = term,
          ranges = {{
              space = 'friends_of_peppa',
              key_min = { kind = 'included', key = {2} },
              key_max = { kind = 'included', key = {2} },
          }},
      })

```





Приведенный выше пример поможет сделать первые шаги в работе с данными в Picodata.
Подробнее о внутренней архитектуре кластера Picodata см. в разделе
[Cхема инициализации кластера](../clustering). 

Параметры запуска из командной строки описаны в разделе [Аргументы командной строки Picodata](../cli).

---
[Исходный код страницы](https://git.picodata.io/picodata/picodata/docs/-/blob/main/docs/tutorial.md)

