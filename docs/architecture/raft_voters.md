# Raft и отказоустойчивость
Алгоритм [Raft](../general/glossary.md#raft) в Picodata обеспечивает отказоустойчивость распределенной
системы при выходе из строя части ее узлов. Это достигается с помощью:

- использования [зон доступности](../tutorials/deploy_on_hosts.md#failure-domains) для эффективного распределения реплик
  кластера между физическими локациями;
- динамического переключения [голосующих узлов](../general/glossary.md#node-states) в Raft.

## Динамическое переключение голосующих узлов в Raft (Raft voter failover) {: #raft-voter-failover }

Все узлы Raft в кластере делятся на два типа: голосующие (`voter`) и
неголосующие (`learner`). За консистентность raft-группы отвечают только
узлы первого типа. Для коммита каждой транзакции требуется собрать
кворум из `N/2 + 1` голосующих узлов. Неголосующие узлы в кворуме не
участвуют.

Чтобы сохранить баланс между надежностью кластера и удобством его
эксплуатации, в Picodata предусмотрена удобная функция — динамическое
переключение типа узлов. Если один из голосующих узлов становится
недоступным или прекращает работу (что может нарушить кворум в Raft), то
тип `voter` автоматически присваивается одному из доступных неголосующих
узлов. Переключение происходит незаметно для пользователя.

Количество голосующих узлов в кластере не настраивается и зависит только
от общего количества инстансов:

- 1 инстанс — 1 голосующий узел;
- 2 инстанса — 2 голосующих узла;
- 3 или 4 инстанса — 3 голосующих узла;
- 5 и более инстансов — 5 голосующих узлов;

## Пример распределения голосующих узлов
Приведем пример кластера с одним уровнем распределения узлов между
локациями. Пусть это будет два датацентра (`MSK`, `SPB`) и третья
локация, на которой запущен узел-арбитр. Вне зависимости от общего числа
узлов, в кластере предполагается наличие всего 5 голосующих узлов,
которые, в данном случае, распределятся так:

- 2 узла в локации `MSK`;
- 2 узла в локации `SPB`;
- 1 узел-арбитр в третьей локации.

Если весь датацентр в локации `SPB` теряет доступность и связь с арбитром,
то его 2 голосующих узла перемещаются в датацентр локации `MSK`. При
восстановлении связности, голосующие узлы возвращаются обратно и
исходная конфигурация восстанавливается.

В случае, если лишь отдельный сервер с голосующим узлом в `SPB` теряет
связь, то право голоса перемещается внутри локации, т.е. переходит к
другому узлу в `SPB`. Если сервер восстанавливает связь, то он уже не
станет автоматически голосующим, т.к. схема распределения не будет этого
требовать.

См. [отдельный подраздел](../tutorials/deploy_on_hosts.md) с описанием развертывания кластера на физических узлах.


---
[Исходный код страницы](https://git.picodata.io/picodata/picodata/docs/-/blob/main/docs/architecture/raft_voters.md)
