---
title: Topology RFC (v3.11)
tags: Picodata, RFC
---

## Topology RFC (v3.11 for Workgroups)

*2022-06-17*
*Yaroslav Dynnikov*
*Alexander Tolstoy*

В данном документе рассматриваются различные сценарии работы с кластером. Все они основаны на одном и том же принципе: запуске и объединении отдельных экземпляров Picodata в распределенный кластер. При этом сложность развертывания и поддержания работоспособности кластера зависит только от сложности его топологии.

[TOC]

---

## Минимальный вариант кластера

Picodata может создать кластер, состоящий всего из одного экземпляра/инстанса. Обязательных параметров у него нет, что позволяет свести запуск к выполнению всего одной простой команды:

```
picodata run
```

Можно добавлять сколько угодно последующих инcтансов — все они будут подключаться к этому кластеру. Каждому интансу следует задать отдельную рабочую директорию (параметр `--data-dir`), а также указать адрес и порт для приема соединений (параметр `--listen`) в формате `<HOST>:<PORT>`. Фактор репликации по умолчанию равен 1 — каждый инстанс образует отдельный репликасет. Если для `--listen` указать только порт, то будет использован IP-адрес по умолчанию (127.0.0.1):

```
picodata run --data-dir i1 --listen :3301
picodata run --data-dir i2 --listen :3302
picodata run --data-dir i3 --listen :3303
```

> Q: Нужно ли для небольшого кластера указывать параметр `--peer`?
>
> A: Это не обязательно, т.к. по умолчанию `--peer` имеет такое же значение по умолчанию как и `--listen`: _127.0.0.1:3301_.


## Кластер на нескольких серверах

Выше был показан запуск Picodata на одном сервере, что удобно для тестирования и отладки, но не отражает сценариев полноценного использования кластера. Поэтому пора запустить Picodata на нескольких серверах. Предположим, что их два: `192.168.0.1` и `192.168.0.2`. Порядок запуска будет следующим:

На `192.168.0.1`:
```shell
picodata run --listen 0.0.0.0 --advertise 192.168.0.1
```

На `192.168.0.2`:
```shell
picodata run --listen 0.0.0.0 --advertise 192.168.0.2 --peer 192.168.0.1
```
На что нужно обратить внимание:

Во-первых, для параметра `--listen` вместо стандартного значения `127.0.0.1` надо указать `0.0.0.0`. Порт указывать не обязательно (по умолчанию везде используется `:3301`).

Значение параметра `--listen` не хранится в кластерной конфигурации и может меняться при перезапуске инстанса. 

Во-вторых, надо дать инстансам возможность обнаружить друг друга для того чтобы механизм [discovery](discovery.md) правильно собрал все найденные экземпляры Picodata в один кластер. Для этого в параметре `--peer` нужно указать адрес какого-либо соседнего инстанса. По умолчанию значение параметра `--peer` установлено в `127.0.0.1:3301`. Параметр `--peer` не влияет больше ни на что, кроме механизма обнаружения других инстансов.

Параметр `--advertise` используется для установки публичного IP-адреса инстанса. Параметр сообщает, по какому адресу остальные инстансы должны обращаться к текущему инстансу. По умолчанию он определяется автоматически как `<HOSTNAME>:<LISTEN_PORT>`.

Значение параметра `--advertise` анонсируется кластеру при запуске инстанса. Его можно поменять при перезапуске инстанса или в процессе его работы командой `picodata set-advertise`. 

## Питомцы против стада

Чтобы проще было отличать инстансы друг от друга, им можно давать имена:

```
picodata run --instance-id barsik
```

Если имя не дать, то оно будет сгенерировано автоматически в момент добавления в кластер. Имя инстанса задается один раз и не может быть изменено в дальнейшем (например, оно постоянно сохраняется в снапшотах инстанса). В кластере нельзя иметь два инстанса с одинаковым именем — второй инстанс сразу после запуска получит ошибку при добавлении в кластер. Тем не менее, имя можно повторно использовать если предварительно исключить первый инстанс с таким именем из кластера. Это делается командой `picodata expel barsik`.

## Репликация и зоны доступности (failure domains)

Количество реплик настраивается параметром `--init-replication-factor`.
Этот параметр играет роль только в момент инициализации кластера. Bootstrap-лидер записывает это значение в конфигурацию кластера (`replication-factor`). В дальнейшем значение `--init-replication-factor` игнорируется.

Отредактировать фактор репликации, сохраненный в конфигурации кластера, можно командой `picodata set-replication-factor`. Редактирование конфигуарции сказывается только на вновь добавляемых инстансах, но не затрагивает уже работающие.

Этот параметр составляет часть конфигурации кластера и обозначает *желаемое* количество реплик в каждом репликасете.

При добавлении инстанса фактор репликации будет записан в конфигурацию кластера, но такой сценарий позволяет изменять его только в сторону увеличения. При этом, сохраняется возможность уменьшить фактор репликации для вновь добавляемых инстансов командой `picodata set-replication-factor`(с уже работающими инстансами ничего не произойдет).

По мере усложнения топологии возникает еще один вопрос — как не допустить объединения в репликасет инстансов из одного и того же датацентра. Для этого введен параметр `--failure-domain` — _зона доступности_, отражающая признак физического размещения сервера, на котором выполняется инстанс Picodata. Это может быть как датацентр, так и какое-либо другое обозначение расположения: регион (например, `eu-east`), стойка, сервер, или собственное обозначение (blue, green, yellow). Ниже показан пример запуска инстанса Picodata с указанием зоны доступности:

```
picodata run --replication-factor 2 --failure-domain region=us,zone=us-west-1
```

Добавление инстанса в репликасет происходит по следующим правилам:

- Если в каком-либо репликасете количество инстансов меньше необходимого фактора репликации, то новый инстанс добавляется в него при условии, что их параметры `--failure-domain` отличаются.
- Если подходящих репликасетов нет, то Picodata создает новый репликасет.

Параметр `--failure-domain` играет роль только в момент добавления инстанса в кластер. **Принадлежность инстанса репликасету впоследствии не меняется**.

Как и параметр `--advertise`, значение параметра`--failure-domain` каждого инстанса можно редактировать:

- Либо перезапустив инстанс с новыми параметрами.
- Либо в процессе его работы командой `picodata set-failure-domain`.

Добавляемый инстанс должен обладать тем же набором параметров, которые уже есть в кластере. Например, инстанс `dc=msk` не сможет присоединиться к кластеру с `--failure-domain region=eu/us` и вернет ошибку.

## Группы репликасетов

Иногда бывает так, что в разных репликасетах хочется использовать разный фактор репликации или ограничить размер хранимых данных. Классический пример — разделение кластера на узлы хранения (`storage`) и узлы маршрутизации (`router`).

Такое разделение делается с помощью параметра `--replicaset-group`. По умолчанию инстансы добавляются в неявную группу `"default"`, но пользователь может создать сколько угодно новых групп, перечислив их в переменной `PICODATA_AVAILABLE_REPLICASET_GROUPS` подобным образом:

```bash
export PICODATA_AVAILABLE_REPLICASET_GROUPS=\
"name=storage:replication-factor=3,"\
"name=router:storage-weight=0"
```

Теперь при запуске инстансов можно будет указать группу:

```
picodata run --replicaset-group router
```

Наличие групп не ограничивает пользователя в создании новых. Как и в случае с `--replication-factor`, новые группы можно добавлять вместе с добавлением новых инстансов.

## Кейс: два датацентра по две реплики

Picodata старается не объединять в один репликасет инстансы, у которых совпадает хотя бы один домен. Но иногда это прямо таки необходимо. Чтобы ограничить Picodata в бесконечном создании репликасетов, можно воспользоваться флагом `--max-replicaset-count` (по умолчанию `inf`).

Как и `--replication-factor`, параметр `--max-replicaset-count` можно назначать разным для разных групп репликасетов.

Как и другие параметры, `--max-replicaset-count` редактируется в любой момент:

- При добавлении нового инстанса
- В процессе его работы командой `picodata set-max-replicaset-count`

Важно учитывать, что параметр `--max-replicaset-count` нельзя сделать меньше существующего количества репликасетов.

## Файлы конфигурации

Существует три способа передать Picodata параметры конфигурации. Они приведены ниже в порядке возрастания приоритета:

1. Файл конфигурации (yaml / toml)
2. Переменные окружения `PICODATA_<PARAM>=<VALUE>`
3. Аргументы командной строки `--param value`

Мы перечислили достаточно много разнобразных параметров, некоторые из которых делают команду запуска достаточно длинной. Вместо отдельных команд можно использовать файл конифгурации. Пример:

<h5 a><strong><code>c1.toml</code></strong></h5>

```
[[available-replicaset-groups]]:
name = "storage"
max-replicaset-count = 30
replication-factor = 4

[[available-replicaset-groups]]
name = "router"
storage-weight = 0
```
Пример запуска инстанса Picodata c использованием файла конфигурации:

```
picodata run --cfg custom-config.toml
```

## Динамическое переключение голосующих узлов в Raft (Raft voter failover)

Все узлы Raft в кластере делятся на два типа: голосующие (`voter`) и неголосующие (`learner`). За консистентность Raft-группы отвечают только узлы первого типа. Для коммита каждой транзакции требуется собрать кворум из `N/2 + 1` из голосующих узлов. Неголосующие узлы в кворуме не участвуют.

Чтобы сохранить баланс между надежностью кластера и удобством его эксплуатации, в Picodata предусмотрена удобная функция — динамическое переключение типа у узлов. Если один из голосующих узлов становится недоступен или прекращает работу (что может нарушить кворум в Raft), то тип `voter` автоматически присваивается одному из доступных неголосующих узлов. Переключение происходит незаметно для пользователя.

Количество голосующих узлов в кластере не настраивается и зависит только от общего количества инстансов. Если инстансов 1 или 2, то голосующий узел один. Если инстансов 3 или 4, то таких узлов три. Для кластеров с 5 или более инстансами — пять голосующих узлов.

## Configuration reference

> `--cfg <path>`
: Read configuration parameters from file (toml / yaml).
*env*: `PICODATA_CFG`
*default*: *none*

`--data-dir`
: Here the instance persists all of its data.
*env*: `PICODATA_DATA_DIR`
*default*: `.`


`--listen`
: Socket bind address.
*env*: `PICODATA_LISTEN`
*default*: `localhost:3301`
 
`--peer <[host][:port]>`
: Address of other instance(s).
*env*: `PICODATA_PEER`
*default*: `localhost:3301`

`--advertise <[host][:port]>`
: Address the other instances should use to connect to this instance.
*env*: `PICODATA_ADVERTISE`
*default*: `%hostname%:%listen_port%`
:hammer_and_wrench:: Если `%listen% == "0.0.0.0"`, то надо подставлять `%hostname%`. Сейчас по умолчанию всегда просто `%listen%`.

`--cluster-id <name>`
: Name of the cluster. The instance will refuse to join the cluster with a different name.
*env*: `PICODATA_CLUSTER_ID`
*default*: `demo`

`--instance-id <name>`
: Name of the instance.
*env*: `PICODATA_INSTANCE_ID`
*default*: `i%raft_id%`, e.g. `i1`, `i42`, etc.
:hammer_and_wrench:: Надо придумать, как идентифицировать каждого клиента в больших наборах (advertise?). ID генерируется только при обработке запроса.

`--failure-domain <key=value,...>`
: Comma-separated list describing physical location of the server. Each domain is a key-value pair. Until max replicaset count is reached, picodata will never put two instances with a common failure domain in the same replicaset. Instead, new replicasets will e created. They'll be filled with other instances until desired replication factor is satisfied.
*env*: `PICODATA_FAILURE_DOMAIN`
*default*: *none*
:hammer_and_wrench:: Объяснить правила "common failure domain". 

`--replicaset-group <name>`
: Name of the replicaset group. It's an error to run instance with a group changed.
*env*: `PICODATA_REPLICASET_GROUP`
*default*: `default`
:hammer_and_wrench: Зачем это? Без картинки, поясняющей архитектуру кластера, объяснить сложновато.

`--init-replication-factor <number>`
: Total number of replicas (copies of data) for each replicaset in the current group.
*env*: `PICODATA_INIT_REPLICATION_FACTOR`
*default*: `1`
:hammer_and_wrench: Учитывается только при создании группы. Потом игнорируется.

`--init-storage-weight <number>`
: Proportional capacity of current instance. Common for each instance in the current group.
*env*: `PICODATA_INIT_STORAGE_WEIGHT`
*default*: `1`
:hammer_and_wrench: Учитывается только при создании группы. Потом игнорируется.

`--max-replicaset-count`
: Maximum number of replicasets in the current group.
*env*: `PICODATA_MAX_REPLICASET_COUNT`
*default*: don't modify
:hammer_and_wrench: Если меньше текущего размера группы, то игнорируется. Если в текущей группе нет места, то ошибка. Если больше — настройка применяется к текущей группе репликасетов.
