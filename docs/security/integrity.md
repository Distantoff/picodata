# Контроль целостности

Данный раздел описывает средства контроля целостности ПО Picodata при
работе в защищенной ОС.

## Объекты контроля {: #control_objects }

Объектами контроля целостности в Picodata выступают:

- конфигурация СУБД
- конфигурация БД
- программный код СУБД
- процедуры, хранимые в БД <!-- TODO link sql routines doc -->

С точки зрения реализации защиты, эти объекты овеществляются в виде
файлов `*.xlog` / `*.snap` в рабочей директории инстанса. Таким
образом, контроль целостности реализуется через меры, направленные на
защиту рабочих файлов в директории, заданной при запуске инстанса
Picodata.

## Реализация контроля целостности {: #implementation }

### Контроль при запуске инстанса {: #instance_start }

Контроль целостности происходит во время повторного запуска инстанса
Picodata, когда в рабочей директории присутствуют ранее созданные файлы
(объекты контроля). Для такой проверки предусмотрены следующие механизмы:

- внутренняя проверка валидности журналов `*.xlog`/`*.snap` средствами
  Picodata. Для каждой записи журнала производится проверка контрольной
  суммы (crc32). Изменение любой записи приводит к недействительности
  всего журнала. Подробнее см. [устройство формат
  WAL](https://www.tarantool.io/ru/doc/latest/dev_guide/internals/file_formats/#the-snapshot-file-format){:target="_blank"}
- размещение рабочей директории инстанса Picodata на отдельном
  логическом разделе, в опциях монтирования которого использован
  параметр `iversion`. Одновременно с этим следует настроить политику
  проверки целостности (службы `integrity-notifier` и
  `integrity-scanner` в защищенной ОС) на единовременную проверку
  содержимого рабочей директории. Подробнее см. [документацию ОС Альт 8
  СП](https://www.basealt.ru/altsp/docs){:target="_blank"}, Руководство
  по комплексу средств защиты, п. 3.6.2. "Подсистема IMA/EVM"
- сверка контрольных сумм (md5sum) рабочих файлов вручную и с помощью
  средств автоматизации в защищенной ОС
- запуск инстанса Picodata из-под специально созданного пользователя
  `picodata`, который эксклюзивно владеет правом записи в рабочую
  директорию инстанса

Данные механизмы подтверждают, что в промежутке времени между
остановкой инстанса и его повторным запуском данные файлы не были
изменены и/или повреждены.

_Примечание_: Проверка целостности для первого запуска инстанса не применима и не
производится (по причине отсутствия рабочих файлов).

### Контроль во время работы инстанса {: #instance_running }

Функциональность контроля целостности во время эксплуатации системы
обеспечивается устройством и особенностями распределенной in-memory СУБД
Picodata. К таким особенностям относятся:

- реализация форматно-логического контроля данных (обязательное
  соответствие данных указанным типам для их колонок)
- отсутствие интерфейса доступа к системным таблицам в консоли Picodata
- невозможность использования учетной записи администратора для
  удаленного подключения к инстансу (настройка по умолчанию в Picodata)

Проверка целостности во время работы инстанса в виде традиционной сверки
контрольных сумм файлов не применима. Целостность объектов контроля в
запущенном кластере (содержимое ОЗУ) обеспечивается средствами
защищенной ОС.

## Нарушение целостности {: #integrity_violation }

Событием нарушения целостности является повреждение рабочих файлов
инстанса или использование заведомо неверных параметров в `picodata
run`, что приводит к одной из следующих ситуаций:

- невозможности запуска инстанса
- неприсоединению инстанса к кластеру
- созданию параллельного второго кластера

### Информирование о нарушении целостности {: #violation_reporting }

Если инстанс не запущен, то подключиться к нему невозможно, а все
попытки подключения будут зафиксированы в системном журнале защищенной ОС.

Событие неуспешного запуска инстанса фиксируется в стандартном выводе
(stdout) в виде ошибок `ER_INVALID_XLOG`,`ER_INVALID_XLOG_NAME`,
`ER_INVALID_XLOG_ORDER`, свидетельствующих о невозможности использования
файлов журнала.

События, связанные с запуском пустого инстанса после
[ребутстрапа](../overview/glossary.md#bootstrap), фиксируются в журнале
аудита инстанса.

### Блокировка пользователей {: #user_blocking }

Во всех этих случаях нарушения целостности пользователь автоматически
теряет доступ к каким-либо данным инстанса (т.к. он не запущен).

Также, пользователь автоматически блокируется после 4 неудачных попыток
входа на локальный инстанс.

Блокировка пользователя по запросу заключается в отзыве у него
привилегии `SESSION`. Пример команды:

```
ALTER USER "alice" WITH NOLOGIN
```

Блокировка и разблокировка пользователя доступна только администратору
СУБД (пользователю `admin`).

См. также:

- [Управление доступом](../tutorial/access_control.md)
