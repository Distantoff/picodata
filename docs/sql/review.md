# Принципы работы распределенного SQL
## Общая схема {: #queries }
На схеме ниже показан общий принцип работы распределенного SQL-запроса в
кластере с одним роутером.

![Distributed query](picosql-curves.svg "general distributed query flow")

На схеме <span style="color:#ff0000ff">_красным_</span> показан исходный
пользовательский запрос, <span style="color:#fcc501ff">_желтым_</span> —
план запроса (IR, intermediate representation), <span
style="color:#39cb00ff">_зеленым_</span> — собранные фрагменты ответов,
<span style="color:#00c8e5ff">_голубым_</span> — консолидированный ответ
на пользовательский запрос в виде списка кортежей, обработанного
функцией MapReduce.

## Работа с распределенными данными {: #data }
Распределенный SQL требует собственно распределения данных между
различными репликасетами (шардами) кластера. Это достигается за счет
использования встроенной библиотеки [Vshard](../glossary.md#vshard).
Взаимодействие Picodata SQL и Vshard заключается в разделении функций:

- Picodata SQL работает с шардированными [спейсами](../glossary.md#space)
  (таблицами), отдельные строки (кортежи) которых распределяются по
  разным [бакетам](../glossary.md#bucket);
- Vshard работает с распределением бакетов по
  [репликасетам](../glossary.md#replicaset).

У каждого распределенного спейса в схеме данных всегда есть два признака:

- наличие столбца `bucket_id`, связывающего каждую строку спейса с
  определенным номером бакета;
- наличие ключа шардирования, состояшего минимум из одного столбца, по
  которому производится расчет значения `bucket_id`.

Picodata SQL включает внутреннюю функцию по вычислению `bucket_id` на
основе хешей значений, которые передаются в распределенных запросах. В
шардированном спейсе `bucket_id` хранит вычисленное значение (номер
бакета) от функции шардирования (на вход подается набор колонок, по
которым происходит шардирование, и количество бакетов в кластере). Для
запроса `SELECT` значение `bucket_id` нужно чтобы узел с ролью
`vshard.router` мог понять, на каком узле с ролью `vshard.storage`
расположены искомые данные. Соответственно, для запроса `INSERT`
требуется знать, на какой узел записывать данные. В общем случае, две
записи с одинаковыми значениями в столбцах, относящихся к
`sharding_key`, попадут в один бакет.

Описание поддерживаемых запросов и их синтаксиса приведены в разделе:
[Команды SQL](../queries)

---
[Исходный код страницы](https://git.picodata.io/picodata/picodata/docs/-/blob/main/docs/sql/review.md)
