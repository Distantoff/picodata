# Использование журнала аудита

## Общие сведения  {: #intro }

На каждом инстансе Picodata можно включить регистрацию событий и
запись соответствующей информации в журнал аудита.

Журнал аудита позволяет администратору отслеживать все важные события,
которые влияют на безопасность кластера Picodata, включая, например,
создание новых учетных записей, изменение их паролей и привилегий, и
т.д.

## Структура журнала {: audit-log-structure }

Журнал представляет собой массив строк с разметкой `json`, где каждой
строке соответствует одно событие. Пример журнала:

```
{"message":"audit log is ready","severity":"low","time":"2023-11-27T17:36:23.566+0300","title":"init_audit"}
{"message":"instance is starting","severity":"low","time":"2023-11-27T17:36:23.566+0300","title":"local_startup"}
{"auth_type":"md5","message":"created user `PEPPA`","severity":"high","time":"2023-11-27T18:20:36.178+0300","title":"create_user","user":"PEPPA"}
{"message":"created table `friends_of_peppa`","name":"friends_of_peppa","severity":"medium","time":"2023-11-27T18:21:48.286+0300","title":"create_table"}
```

Каждая запись журнала включает следующие обязательные элементы:

- `message` – название события (например: `audit log is ready`,` instance is starting`)
- `severity` – важность события (`low` / `medium` / `high`)
- `time` – подробная временная метка, привязанная к дате и времени события
- `title` – наименование события безопасности (например, `create_user`)
 <!--TBD
  - уникальный идентификатор события, составленный из трех чисел:
    - `count` – счетчик событий
    - `gen` – уникальный номер события
    - `id` – идентификатор `raft_id` инстанса
- `description` – краткое описание события -->

В зависимости от типа события, записи могут также содержать
дополнительные поля. Например, поле `user` с указанием субъекта доступа:
пользователя, выполнившего операцию, либо создаваемого пользователя (как
в примере выше).
<!--TBD
 Помимо этого, запись содержит дополнительные идентификаторы затронутых
субъектов и объектов, например, имена пользователей, БД, изменения ACL и
т.д. Дополнительные поля записи непосредственно зависят от типа события. -->

Полный список возможных событий, которые регистрируются в журнал
инстанса Picodata, указан в справочнике [Регистрируемые события
безопасности](../reference/audit_events.md).

## Способы ведения журнала {: audit-log-config }

Каждый узел кластера ведет свой собственный журнал, но настройка
параметров журнала производится централизованно. В зависимости от
настройки, журнал может вестись следующими способами:

- `file` — в виде текстового файла, по строчке на событие. В таком
случае смотреть его можно средствами защищенной ОС, а также при помощи
API, предоставляемых самой СУБД.
- `pipe` — с использованием внешнего процесса-коллектора, который СУБД должна
будет запустить при старте узла. В этом случае журнал будет поступать в
текстовом виде на вход процессу-коллектору (через `stdin`). Вся дальнейшая
логика работы целиком зависит от запущенного процесса; например, он
может отправлять журнал в централизованное внешнее хранилище.
- `syslog` — с использованием общесистемного логирования и встроенных
средств защищенной ОС. Подобная схема решает вопросы архивации, ротации
и оповещения администратора. В качестве реализации
[Syslog](https://ru.wikipedia.org/wiki/Syslog){:target="_blank"} на
современных дистрибутивах Linux часто используется `journald` (компонент
системного менеджера
[Systemd](https://ru.wikipedia.org/wiki/Systemd){:target="_blank"}),
который имеет множество настроек и даже позволяет отправлять журналы на
внешние хосты.

## Включение журнала {: #enable-audit-log }

По умолчанию, запись событий не ведется. Включить журнал можно при
[запуске инстанса в интерактивном режиме](../reference/cli.md#audit)
<!-- - с помощью API-функции [pico.audit()](../reference/api.md#picoaudit) -->

Для примера, задействуем файл журнала при запуске инстанса с интерактивной консолью

Вывод журнала в текстовый файл:

```bash
picodata run -i --audit=/tmp/audit.log
```

Вывод журнала в syslog:

```bash
picodata run -i --audit=syslog:
```

## Получение доступа к журналу {: #access-audit-log }

Если журнал выводится в отдельный текстовый файл, то отслеживать
изменения в нем можно следующей командой:

```bash
tail -f /tmp/audit.log
```

Вывод журнала в syslog в современных дистрибутивах Linux предполагает
доступ к данным с помощью
[journalctl](https://www.man7.org/linux/man-pages/man1/journalctl.1.html){:target="_blank"}
(компонента Systemd). Для изоляции событий, относящихся только к
инстансу Picodata, используйте такую команду:

```bash
journalctl -f _COMM=picodata
```
