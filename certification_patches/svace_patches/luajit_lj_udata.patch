diff --git a/src/lj_udata.c b/src/lj_udata.c
index 1b7841fa..22426dbb 100644
--- a/src/lj_udata.c
+++ b/src/lj_udata.c
@@ -6,6 +6,8 @@
 #define lj_udata_c
 #define LUA_CORE
 
+#include <assert.h>
+
 #include "lj_obj.h"
 #include "lj_gc.h"
 #include "lj_err.h"
@@ -57,6 +59,7 @@ void *lj_lightud_intern(lua_State *L, void *p)
     setmref(g->gc.lightudseg, segmap);
   }
   g->gc.lightudnum = segnum;
+  assert(segmap != NULL);
   segmap[segnum] = up;
   return (void *)(((uint64_t)segnum << LJ_LIGHTUD_BITS_LO) | lightudlo(u));
 }
