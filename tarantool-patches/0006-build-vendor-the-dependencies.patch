From 1764ff2cf6c658325c6d05619ba2b40ca77872d1 Mon Sep 17 00:00:00 2001
From: Georgy Moshkin <gmoshkin@picodata.io>
Date: Wed, 2 Nov 2022 10:17:04 +0300
Subject: [PATCH] build: vendor the dependencies

---
 static-build/CMakeLists.txt              | 34 ++++-----------------
 static-build/openssl-111q-gh-18720.patch | 11 -------
 static-build/readline80-001.patch        | 38 ------------------------
 3 files changed, 6 insertions(+), 77 deletions(-)
 delete mode 100644 static-build/openssl-111q-gh-18720.patch
 delete mode 100644 static-build/readline80-001.patch

diff --git a/static-build/CMakeLists.txt b/static-build/CMakeLists.txt
index 4dd4adc19..f34985de3 100644
--- a/static-build/CMakeLists.txt
+++ b/static-build/CMakeLists.txt
@@ -9,18 +9,6 @@ project(tarantool-static C CXX)
 
 include(FindPackageMessage)
 include(ExternalProject)
-set(LIBICU_VERSION release-71-1/icu4c-71_1)
-set(LIBICU_HASH e06ffc96f59762bd3c929b217445aaec)
-set(LIBICONV_VERSION 1.17)
-set(LIBICONV_HASH d718cd5a59438be666d1575855be72c3)
-set(OPENSSL_VERSION 1.1.1q)
-set(OPENSSL_HASH c685d239b6a6e1bd78be45624c092f51)
-set(ZLIB_VERSION 1.2.12)
-set(ZLIB_HASH 5fc414a9726be31427b440b434d05f78)
-set(NCURSES_VERSION 6.3-20220716)
-set(NCURSES_HASH 2b7a0e31ebbd8144680f985d61f5bbd5)
-set(READLINE_VERSION 8.0)
-set(READLINE_HASH 7e6c1f16aee3244a69aba6e438295ca3)
 set(BACKUP_STORAGE https://distrib.hb.bizmrg.com)
 
 include(../cmake/os.cmake)
@@ -73,8 +61,7 @@ endif()
 # https://github.com/openssl/openssl/issues/18720
 #
 ExternalProject_Add(openssl
-    URL ${BACKUP_STORAGE}/openssl/openssl-${OPENSSL_VERSION}.tar.gz
-    URL_MD5 ${OPENSSL_HASH}
+    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/openssl-1.1.1q
     CONFIGURE_COMMAND <SOURCE_DIR>/config
         CC=${CMAKE_C_COMPILER}
         CXX=${CMAKE_CXX_COMPILER}
@@ -86,16 +73,13 @@ ExternalProject_Add(openssl
         --libdir=lib
         no-shared
     INSTALL_COMMAND ${CMAKE_MAKE_PROGRAM} install_sw
-    PATCH_COMMAND patch -d <SOURCE_DIR> -p1 <
-        "${CMAKE_CURRENT_SOURCE_DIR}/openssl-111q-gh-18720.patch"
 )
 
 #
 # ICU
 #
 ExternalProject_Add(icu
-    URL https://github.com/unicode-org/icu/releases/download/${LIBICU_VERSION}-src.tgz
-    URL_MD5 ${LIBICU_HASH}
+    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/icu4c-62_1
     # By default libicu is built by using clang/clang++ compiler (if it
     # exists). Here is a link for detecting compilers at libicu configure
     # script: https://github.com/unicode-org/icu/blob/7c7b8bd5702310b972f888299169bc3cc88bf0a6/icu4c/source/configure.ac#L135
@@ -122,8 +106,7 @@ ExternalProject_Add(icu
 # ZLIB
 #
 ExternalProject_Add(zlib
-    URL ${BACKUP_STORAGE}/zlib/zlib-${ZLIB_VERSION}.tar.gz
-    URL_MD5 ${ZLIB_HASH}
+    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/zlib-1.2.12
     CONFIGURE_COMMAND env
         CC=${CMAKE_C_COMPILER}
         CFLAGS=${DEPENDENCY_CFLAGS}
@@ -138,8 +121,7 @@ ExternalProject_Add(zlib
 # Ncurses
 #
 ExternalProject_Add(ncurses
-    URL ${BACKUP_STORAGE}/ncurses/ncurses-${NCURSES_VERSION}.tgz
-    URL_MD5 ${NCURSES_HASH}
+    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/ncurses-6.3-20220716
     CONFIGURE_COMMAND <SOURCE_DIR>/configure
         CC=${CMAKE_C_COMPILER}
         CXX=${CMAKE_CXX_COMPILER}
@@ -175,8 +157,7 @@ ExternalProject_Add(ncurses
 # Patched to fix file descriptor leak with zero-length history file.
 #
 ExternalProject_Add(readline
-    URL https://ftp.gnu.org/gnu/readline/readline-${READLINE_VERSION}.tar.gz
-    URL_MD5 ${READLINE_HASH}
+    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/readline-8.0
     CONFIGURE_COMMAND <SOURCE_DIR>/configure
         CC=${CMAKE_C_COMPILER}
         CFLAGS=${DEPENDENCY_CFLAGS}
@@ -185,8 +166,6 @@ ExternalProject_Add(readline
 
         --prefix=<INSTALL_DIR>
         --disable-shared
-    PATCH_COMMAND patch -d <SOURCE_DIR> -p0 <
-        "${CMAKE_CURRENT_SOURCE_DIR}/readline80-001.patch"
 )
 
 #
@@ -194,8 +173,7 @@ ExternalProject_Add(readline
 #
 if (APPLE)
     ExternalProject_Add(iconv
-        URL https://ftp.gnu.org/pub/gnu/libiconv/libiconv-${LIBICONV_VERSION}.tar.gz
-        URL_MD5 ${LIBICONV_HASH}
+        SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../../vendor/libiconv-1.17
         CONFIGURE_COMMAND <SOURCE_DIR>/configure
             CC=${CMAKE_C_COMPILER}
             CFLAGS=${DEPENDENCY_CFLAGS}
diff --git a/static-build/openssl-111q-gh-18720.patch b/static-build/openssl-111q-gh-18720.patch
deleted file mode 100644
index 5b64b5440..000000000
--- a/static-build/openssl-111q-gh-18720.patch
+++ /dev/null
@@ -1,11 +0,0 @@
-diff -ru a/test/v3ext.c b/test/v3ext.c
---- a/test/v3ext.c	2022-07-05 12:08:33.000000000 +0300
-+++ b/test/v3ext.c	2022-07-14 21:07:10.586081541 +0300
-@@ -8,6 +8,7 @@
-  */
- 
- #include <stdio.h>
-+#include <string.h>
- #include <openssl/x509.h>
- #include <openssl/x509v3.h>
- #include <openssl/pem.h>
diff --git a/static-build/readline80-001.patch b/static-build/readline80-001.patch
deleted file mode 100644
index aa72a9dfa..000000000
--- a/static-build/readline80-001.patch
+++ /dev/null
@@ -1,38 +0,0 @@
-			   READLINE PATCH REPORT
-			   =====================
-
-Readline-Release: 8.0
-Patch-ID: readline80-001
-
-Bug-Reported-by:	chet.ramey@case.edu
-Bug-Reference-ID:
-Bug-Reference-URL:
-
-Bug-Description:
-
-The history file reading code doesn't close the file descriptor open to
-the history file when it encounters a zero-length file.
-
-Patch (apply with `patch -p0'):
-
-*** ../readline-8.0-patched/histfile.c	2018-06-11 09:14:52.000000000 -0400
---- histfile.c	2019-05-16 15:55:57.000000000 -0400
-***************
-*** 306,309 ****
---- 312,316 ----
-      {
-        free (input);
-+       close (file);
-        return 0;	/* don't waste time if we don't have to */
-      }
-*** ../readline-8.0/patchlevel	2013-11-15 08:11:11.000000000 -0500
---- patchlevel	2014-03-21 08:28:40.000000000 -0400
-***************
-*** 1,3 ****
-  # Do not edit -- exists only for use by patch
-  
-! 0
---- 1,3 ----
-  # Do not edit -- exists only for use by patch
-  
-! 1
-- 
2.25.1

